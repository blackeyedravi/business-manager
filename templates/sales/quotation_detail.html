{% extends "base.html" %}
{% block content %}

<h3 class="fw-bold mb-4">ðŸ“„ Quotation #{{ quotation.id }}</h3>

<!-- QUOTATION HEADER -->
<div class="card shadow p-4 mb-4">

    <div class="d-flex justify-content-between align-items-start">
        <div>
            <h5 class="fw-bold">Customer: {{ quotation.customer.name }}</h5>
            <p class="mb-1">Date: {{ quotation.date }}</p>

            <p>Status:
                {% if quotation.status == "Draft" %}
                    <span class="badge bg-secondary">Draft</span>
                {% elif quotation.status == "Sent" %}
                    <span class="badge bg-info text-dark">Sent</span>
                {% elif quotation.status == "Accepted" %}
                    <span class="badge bg-success">Accepted</span>
                {% else %}
                    <span class="badge bg-warning text-dark">{{ quotation.status }}</span>
                {% endif %}
            </p>
        </div>

        <!-- âœ… ACTION BUTTONS -->
        <div class="text-end">
            <a href="{% url 'quotation_convert_to_invoice' quotation.id %}"
               class="btn btn-success btn-sm mb-2">
               âžœ Convert to Invoice
            </a>

            <a href="{% url 'quotation_pdf' quotation.id %}" class="btn btn-secondary btn-sm mb-2">
                ðŸ“„ Download PDF
            </a>

            <!-- âœ… DELETE QUOTATION -->
            <form method="post"
                  action="{% url 'quotation_delete' quotation.id %}"
                  class="mt-2">
                {% csrf_token %}
                <button type="submit"
                        class="btn btn-danger btn-sm"
                        onclick="return confirm('Are you sure you want to delete this quotation? This action cannot be undone.')">
                    ðŸ—‘ Delete Quotation
                </button>
            </form>
        </div>
    </div>

</div>

<!-- ITEMS TABLE -->
<div class="card shadow p-4 mb-4">
    <h5 class="fw-bold mb-3">Quotation Items</h5>

    <table class="table table-hover align-middle">
        <thead class="table-dark">
            <tr>
                <th>Product</th>
                <th>Qty</th>
                <th>Unit Price</th>
                <th>Line Total</th>
                <th></th>
            </tr>
        </thead>

        <tbody>
            {% for item in items %}
            <tr>
                <td>
                    {% if item.product %}
                        {{ item.product.name }}
                    {% else %}
                        <em class="text-muted">Deleted Product</em>
                    {% endif %}
                </td>
                <td>{{ item.quantity }}</td>
                <td>P{{ item.price }}</td>
                <td>P{{ item.line_total }}</td>
                <td>
                    <a href="{% url 'quotation_delete_item' quotation.id item.id %}"
                       class="btn btn-sm btn-danger"
                       onclick="return confirm('Remove this item?')">
                        âœ–
                    </a>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="5" class="text-center text-muted">No items added yet.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h4 class="fw-bold text-end">Total: P{{ quotation.total_amount }}</h4>
</div>

<!-- ADD ITEM FORM (INLINE) -->
<div class="card shadow p-4 mb-4">
    <h5 class="fw-bold mb-3">âž• Add Item</h5>

    <form method="post" action="{% url 'quotation_add_item' quotation.id %}">
        {% csrf_token %}

        <div class="row g-3">

            <div class="col-md-4">
                <label class="form-label fw-bold">Product</label>
                <select name="product" class="form-select" required>
                    <option value="">-- Select Product --</option>
                    {% for p in products %}
                        <option value="{{ p.id }}">{{ p.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-3">
                <label class="form-label fw-bold">Quantity</label>
                <input type="number" name="quantity" class="form-control" required>
            </div>

            <div class="col-md-3">
                <label class="form-label fw-bold">Unit Price</label>
                <input type="number" name="unit_price" step="0.01" class="form-control" required>
            </div>

            <div class="col-md-2 d-flex align-items-end">
                <button class="btn btn-primary w-100">Add Item</button>
            </div>

        </div>
    </form>
</div>

{% endblock %}
