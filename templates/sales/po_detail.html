{% extends "base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h3 class="fw-bold mb-0">üì¶ Purchase Order #{{ po.id }}</h3>
        <small class="text-muted">Created on {{ po.date }}</small>
    </div>

    <div class="text-end">
        <p class="mb-2">
            Status:
            {% if po.status == "Pending" %}
                <span class="badge bg-warning text-dark px-3 py-2">Pending</span>
            {% else %}
                <span class="badge bg-success px-3 py-2">Received</span>
            {% endif %}
        </p>

        <div class="btn-group">
            {% if po.status == "Pending" %}
            <a href="{% url 'purchase_order_receive' po.id %}" class="btn btn-success btn-sm">
                ‚úÖ Mark as Received
            </a>
            {% endif %}

            <a href="{% url 'purchase_order_pdf' po.id %}" class="btn btn-outline-secondary btn-sm">
                üìÑ Download PO (PDF)
            </a>

            <!-- ‚úÖ DELETE PURCHASE ORDER -->
            <form method="post"
                  action="{% url 'purchase_order_delete' po.id %}"
                  class="d-inline">
                {% csrf_token %}
                <button type="submit"
                        class="btn btn-danger btn-sm"
                        onclick="return confirm('Are you sure you want to delete this Purchase Order? This action cannot be undone.')">
                    üóë Delete PO
                </button>
            </form>

        </div>
    </div>
</div>

<!-- PO SUMMARY CARD -->
<div class="card shadow-sm border-0 mb-4">
    <div class="card-body">

        <div class="row">
            <div class="col-md-6 mb-3">
                <h6 class="text-uppercase text-muted mb-2">Supplier</h6>
                <h5 class="fw-semibold mb-0">{{ po.supplier.name }}</h5>
                {% if po.supplier.company_name %}
                    <div class="small text-muted">{{ po.supplier.company_name }}</div>
                {% endif %}
                {% if po.supplier.address %}
                    <div class="small text-muted mt-1">{{ po.supplier.address }}</div>
                {% endif %}
                {% if po.supplier.phone %}
                    <div class="small text-muted">üìû {{ po.supplier.phone }}</div>
                {% endif %}
                {% if po.supplier.email %}
                    <div class="small text-muted">‚úâÔ∏è {{ po.supplier.email }}</div>
                {% endif %}
            </div>

            <div class="col-md-3 mb-3">
                <h6 class="text-uppercase text-muted mb-2">Order Details</h6>
                <div><strong>PO Number:</strong> {{ po.id }}</div>
                <div><strong>Date:</strong> {{ po.date }}</div>
            </div>

            <div class="col-md-3 mb-3 text-md-end">
                <h6 class="text-uppercase text-muted mb-2">Total Amount</h6>
                <h3 class="fw-bold text-primary mb-0">P{{ po.total_amount }}</h3>
                {% if po.notes %}
                    <div class="small text-muted mt-2"><strong>Notes:</strong> {{ po.notes }}</div>
                {% endif %}
            </div>
        </div>

    </div>
</div>

<!-- ITEMS TABLE -->
<div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0 fw-semibold">Order Items</h5>
        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addItemModal">
            ‚ûï Add Item
        </button>
    </div>

    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th style="width: 40%;">Product</th>
                        <th class="text-center" style="width: 10%;">Qty</th>
                        <th class="text-end" style="width: 15%;">Cost Price (P)</th>
                        <th class="text-end" style="width: 15%;">Line Total (P)</th>
                        <th class="text-center" style="width: 10%;"></th>
                    </tr>
                </thead>

                <tbody>
                    {% for item in items %}
                    <tr>
                        <td>{{ item.product.name }}</td>
                        <td class="text-center">{{ item.quantity }}</td>
                        <td class="text-end">P{{ item.cost_price }}</td>
                        <td class="text-end fw-semibold">P{{ item.line_total }}</td>
                        <td class="text-center">
                            <a href="{% url 'purchase_order_delete_item' po.id item.id %}"
                               class="btn btn-sm btn-outline-danger"
                               title="Remove item">
                               ‚úñ
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center text-muted py-4">
                            No items added yet. Use <strong>‚ÄúAdd Item‚Äù</strong> to build this purchase order.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>

                {% if items %}
                <tfoot>
                    <tr class="table-light">
                        <th colspan="3" class="text-end">Total</th>
                        <th class="text-end fw-bold">P{{ po.total_amount }}</th>
                        <th></th>
                    </tr>
                </tfoot>
                {% endif %}
            </table>
        </div>
    </div>
</div>

<!-- ADD ITEM MODAL -->
<div class="modal fade" id="addItemModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow">

            <div class="modal-header">
                <h5 class="modal-title">‚ûï Add Item to PO #{{ po.id }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <form method="post" action="{% url 'purchase_order_add_item' po.id %}">
                {% csrf_token %}

                <div class="modal-body">

                    <div class="mb-3">
                        <label class="form-label fw-bold">Product</label>
                        <select name="product" class="form-select" required>
                            <option value="">-- Select Product --</option>
                            {% for p in products %}
                                <option value="{{ p.id }}">{{ p.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Quantity</label>
                        <input type="number" name="quantity" class="form-control" min="1" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Cost Price (P)</label>
                        <input type="number" step="0.01" name="cost_price" class="form-control" min="0" required>
                    </div>

                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Add Item</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancel
                    </button>
                </div>

            </form>

        </div>
    </div>
</div>

{% endblock %}
